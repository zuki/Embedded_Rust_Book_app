# 2.3 メモリマップドレジスタ

マイクロコントローラのペリフェラルにあくせすする4つのレベルのクレートがある。~~STM32F4Discoveryには実用的な4のボードクレートは（`f4`があるとはいえ)ない。~~ `stm32f407g-disc`がありました。

1. マイクロアーキテクチャクレート: `cortex-m`
2. ペリフェラルアクセスクレート(PAC): `stm32f4`
3. HALクレート: `stm32f4xx-hal`
4. ボードクレート: `stm32f407g-disc`

# 2.4 セミホスティング

## `cortex_m_semihosting::debug`

```
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`
qemu: fatal: Lockup: can't escalate 3 to HardFault (current priority -1)

R00=00000000 R01=00000000 R02=00000000 R03=00000000
R04=00000000 R05=00000000 R06=00000000 R07=00000000
R08=00000000 R09=00000000 R10=00000000 R11=00000000
R12=00000000 R13=ffffffe0 R14=fffffff9 R15=00000000
XPSR=40000003 -Z-- A handler
FPSCR: 00000000
Abort trap: 6
dspace@mini:~/develop/rust/f4discovery/app$ echo $?
134
```

これは`memory.x`が`STM32F4Discovery`用のままだったため。`LM3S6965EVB`用に戻して再実行。

```
$ cargo run
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.14s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`

$ echo $?
1
```

## `panic-semihosing`

```
$ cargo run
   Compiling panic-semihosting v0.5.3
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.23s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`
panicked at 'assertion failed: `(left == right)`
  left: `"blue"`,
 right: `"red"`', src/main.rs:19:5
                                      # <= ここで止まりexitしない。^Cも効かないので、killするしかない。
```

これは`Cargo.toml`に`panic-semihosting="0.5.3`としたためであり（英語版のオリジナルBookに書いてあった）`panic-semihosting = { version="0.5.3", features = ["exit"] }`として再実行。

```
$ cargo run
   Compiling panic-semihosting v0.5.3
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.23s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`
panicked at 'assertion failed: `(left == right)`
  left: `"blue"`,
 right: `"red"`', src/main.rs:19:5

$ echo $?
1
```

# 2.5 パニック

`#[panic_handler]`関数を提供する以下のようなクレートを一つだけ指定する。

## `panic-abort`: nightlyが必要

```rust
unsafe { intrinsics::abort() }
```

## `panic-halt`

```rust
loop {
     atomic::compiler_fence(Ordering::SeqCst);
}
```

## `panic-itm`

```rust
let itm = unsafe { &mut *ITM::ptr() };
let stim = &mut itm.stim[0];

iprintln!(stim, "{}", info);

loop {
     atomic::compiler_fence(Ordering::SeqCst)
}
```

## panic-semihosting

```rust
match () {
     // Exit the QEMU process
     #[cfg(feature = "exit")]
     () => debug::exit(EXIT_FAILURE),
     // OK to fire a breakpoint here because we know the microcontroller is connected to a
     // debugger
     #[cfg(not(feature = "exit"))]
     () => asm::bkpt(),
}
```

使用例

```
# panic-semihosting

$ cargo run
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.14s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`
panicked at 'index out of bounds: the len is 3 but the index is 4', src/main.rs:20:14

# panic-halt

$ cargo run
    Updating crates.io index
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.51s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/app`
Killed: 9
```

# 2.6 例外

- `cortex-m-rt`は`exception`属性を提供。この属性をつけた関数は例外ハンドラとなり、関数呼び出しとしては使用できない。

- ハンドラ内では`static mut`変数を安全に使用可能。

- デフォルトの例外ハンドラ`DefaultHander()`が提供されている。これは`exception`属性を使って次のように書き換え可能。ここで、`irqn < 0`はCortex-M例外、`irqn >= 0`はデバイス割り込みを示す番号。

     ```rust
     #[exception]
     fn DefaultHandler(irqn: i16) {}
     ```

- `HardFault`はマシンがinvalid状態になった際に呼ばれ、returnできない。ここで、`ExceptionFrame`は例外発生時にスタックにプッシュされたレジスタへのポインタ。


     ```rust
     fn(&ExceptionFrame) -> ! {}
     ```

## 例外ハンドラ実行例: `fn SysTick()`

```
$ cargo run --example exception
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.17s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/examples/exception`
.....$
```

## 例外ハンドラ実行例: `fn HardFault()`

端末1

```
$ cargo run --release --example hardfault
    Finished release [optimized + debuginfo] target(s) in 3.93s
     Running `gdb -q -x openocd.gdb target/thumbv7em-none-eabihf/release/examples/hardfault`
(...)
489	pub unsafe extern "C" fn Reset() -> ! {
(gdb) continue
Continuing.

Breakpoint 4, main ()
    at /Users/dspace/develop/rust/f4discovery/app/examples/hardfault.rs:11
11	#[entry]
(gdb) next
0x08001838 in HardFaultTrampoline ()
(gdb) next
Single stepping until exit from function HardFaultTrampoline,
which has no line number information.
HardFault (frame=0x2001ffd8) at examples/hardfault.rs:21
21	#[exception]
(gdb) next

Breakpoint 2, HardFault (frame=0x2001ffd8) at examples/hardfault.rs:21
21	#[exception]
(gdb) next
^C
Program received signal SIGINT, Interrupt.
hardfault::__cortex_m_rt_HardFault (ef=0x2001ffd8) at examples/hardfault.rs:25
25	    loop {}
(gdb) quit
```

端末2

```
$ openocd

ExceptionFrame {
    r0: 0x3fffffff,
    r1: 0x00f00000,
    r2: 0x00000000,
    r3: 0x00000000,
    r12: 0x00000000,
    lr: 0x08001643,
    pc: 0x08001648,
    xpsr: 0x61000000,
}
```

```
$ cargo objdump --release --example hardfault -- -d -no-show-raw-insn -print-imm-hex

08001644 ResetTrampoline:
 8001644:      	mvn	r0, #0xc0000000
 8001648:      	ldr	r0, [r0]
 800164a:      	b	#-0x4 <ResetTrampoline+0x6>
```

# 2.7 割り込み

- 割り込みハンドラを定義するために、`cortex-m-rt`が、`#[interrutp]`属性を提供
- ハンドラ内では`static mut`変数を安全に使用可能。
