# 2.2 Hardware

## `STM32F4Discovery`ボード

- STM32F407VGT6 (Cortex-M4 with FPU)
- Flash 1024KB (0x08000000)
- SRAM   128KB (0x20000000)

## terminal 1

```
$ vi .cargo/config
$ vi examples/hello.rs
$ cargo build --example hello
warning: unused import: `debug`
 --> examples/hello.rs:9:28
  |
9 | use cortex_m_semihosting::{debug, hprintln};
  |                            ^^^^^
  |
  = note: `#[warn(unused_imports)]` on by default

warning: 1 warning emitted

    Finished dev [unoptimized + debuginfo] target(s) in 3.96s

$ vi openocd.cfg
=> source [find target/stm32f4x.cfg]

$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 2000 kHz
adapter_nsrst_delay: 100
none separate
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : clock speed 1800 kHz
Info : STLINK v2 JTAG v25 API v2 SWIM v14 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.883108
Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints

Info : accepting 'gdb' connection on tcp/3333
Info : device id = 0x10076413
Info : flash size = 1024kbytes
undefined debug reason 7 - target needs reset
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
adapter speed: 1800 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08001024 msp: 0x20020000
Info : Unable to match requested speed 8000 kHz, using 4000 kHz
Info : Unable to match requested speed 8000 kHz, using 4000 kHz
adapter speed: 4000 kHz
target halted due to breakpoint, current mode: Thread
xPSR: 0x61000000 pc: 0x20000046 msp: 0x20020000
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
adapter speed: 1800 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08001246 msp: 0x20020000

semihosting is enabled
Info : halted: PC: 0x0800047e
Hello, world!
Info : halted: PC: 0x080004ac

Info : The target is not running when halt was requested, stopping GDB.
Info : halted: PC: 0x080004ac
Info : dropped 'gdb' connection
^C
$
```
```
$ openocd
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 2000 kHz
adapter_nsrst_delay: 100
none separate
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : clock speed 1800 kHz
Info : STLINK v2 JTAG v25 API v2 SWIM v14 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 2.883108
Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints
Info : accepting 'gdb' connection on tcp/3333
Info : device id = 0x10076413
Info : flash size = 1024kbytes
semihosting is enabled
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
adapter speed: 1800 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08001246 msp: 0x20020000, semihosting
Info : Unable to match requested speed 8000 kHz, using 4000 kHz
Info : Unable to match requested speed 8000 kHz, using 4000 kHz
adapter speed: 4000 kHz
target halted due to breakpoint, current mode: Thread
xPSR: 0x61000000 pc: 0x20000046 msp: 0x20020000, semihosting
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
adapter speed: 1800 kHz
target halted due to debug-request, current mode: Thread
xPSR: 0x01000000 pc: 0x08001246 msp: 0x20020000, semihosting
Info : halted: PC: 0x08001248
Info : halted: PC: 0x0800047e
Hello, world!
Info : dropped 'gdb' connection
^C
$
```

## terminal 2

```
$ gdb -q target/thumbv7em-none-eabihf/debug/examples/hello
Reading symbols from target/thumbv7em-none-eabihf/debug/examples/hello...
(gdb) target remote :3333
Remote debugging using :3333
0x00000000 in ?? ()
(gdb) load
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x10d0 lma 0x8000400
Loading section .rodata, size 0x300 lma 0x80014d0
Start address 0x08001246, load size 6096
Transfer rate: 10 KB/sec, 2032 bytes/write.
(gdb) monitor arm semihosting enable
semihosting is enabled
(gdb) break main
Breakpoint 1 at 0x8000478: file examples/hello.rs, line 11.
(gdb) continue
Continuing.
Note: automatically using hardware breakpoints for read-only addresses.

Breakpoint 1, main () at examples/hello.rs:11
11	#[entry]
(gdb) next
^C
Program received signal SIGINT, Interrupt.
0x080004ac in hello::__cortex_m_rt_main () at examples/hello.rs:19
19	    loop {}
(gdb) quit
A debugging session is active.

	Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: /Users/dspace/develop/rust/f4discovery/app/target/thumbv7em-none-eabihf/debug/examples/hello, Remote target
Ending remote debugging.
[Inferior 1 (Remote target) detached]
```
```
$ cat openocd.gdb
# 解説より新しい内容になっている。変更はせず。

$ vi .cargo/config

[target.'cfg(all(target_arch = "arm", target_os = "none"))']
runner = "gdb -q -x openocd.gdb"  # コメントアウト

$ cargo run --example hello
warning: unused import: `debug`
 --> examples/hello.rs:9:28
  |
9 | use cortex_m_semihosting::{debug, hprintln};
  |                            ^^^^^
  |
  = note: `#[warn(unused_imports)]` on by default

warning: 1 warning emitted

    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
     Running `gdb -q -x openocd.gdb target/thumbv7em-none-eabihf/debug/examples/hello`
Reading symbols from target/thumbv7em-none-eabihf/debug/examples/hello...
0x080004ac in hello::__cortex_m_rt_main () at examples/hello.rs:19
19	    loop {}
Breakpoint 1 at 0x80012ac: file /Users/dspace/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.12/src/lib.rs, line 562.
Breakpoint 2 at 0x80014c4: file /Users/dspace/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.12/src/lib.rs, line 552.
Breakpoint 3 at 0x8000ff4: file /Users/dspace/.cargo/registry/src/github.com-1ecc6299db9ec823/panic-halt-0.2.0/src/lib.rs, line 32.
Breakpoint 4 at 0x8000478: file examples/hello.rs, line 11.
semihosting is enabled
Loading section .vector_table, size 0x400 lma 0x8000000
Loading section .text, size 0x10d0 lma 0x8000400
Loading section .rodata, size 0x300 lma 0x80014d0
Start address 0x08001246, load size 6096
Transfer rate: 10 KB/sec, 2032 bytes/write.
Note: automatically using hardware breakpoints for read-only addresses.
0x08001248 in Reset ()
    at /Users/dspace/.cargo/registry/src/github.com-1ecc6299db9ec823/cortex-m-rt-0.6.12/src/lib.rs:489
489	pub unsafe extern "C" fn Reset() -> ! {
(gdb) continue
Continuing.

Breakpoint 4, main () at examples/hello.rs:11
11	#[entry]
(gdb) next
^C
Program received signal SIGINT, Interrupt.
0x080004ac in hello::__cortex_m_rt_main () at examples/hello.rs:19
19	    loop {}
(gdb) quit
A debugging session is active.

	Inferior 1 [Remote target] will be detached.

Quit anyway? (y or n) y
Detaching from program: /Users/dspace/develop/rust/f4discovery/app/target/thumbv7em-none-eabihf/debug/examples/hello, Remote target
[Inferior 1 (Remote target) detached]
$
```
