# 2.1 QEMU

- `#![no_main]`を使うのは`#![no_std]`で`main`を使うには`nightly`が必要だから。
- `cargo readobj --bin app -- -file-headers`の`--bin app`は`target/$TRIPLE/debug/app`のシンタックスシュガー

```
$ git clone https://github.com/rust-embedded/cortex-m-quickstart app
$ cd app
$ vi Cargo.toml
$ cargo build
　Finished dev [unoptimized + debuginfo] target(s) in 19.43s

$ cargo readobj --bin app -- -file-headers
    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x427
  Start of program headers:          52 (bytes into file)
  Start of section headers:          620568 (bytes into file)
  Flags:                             0x5000200
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         2
  Size of section headers:           40 (bytes)
  Number of section headers:         21
  Section header string table index: 19

$ cargo size --bin app --release -- -A
app  :
section             size        addr
.vector_table       1024         0x0
.text                204       0x400
.rodata                0       0x4cc
.data                  0  0x20000000
.bss                   0  0x20000000
.uninit                0  0x20000000
.debug_str          3014         0x0
.debug_loc           361         0x0
.debug_abbrev        587         0x0
.debug_info         2219         0x0
.debug_aranges       336         0x0
.debug_ranges        312         0x0
.debug_pubnames     1446         0x0
.debug_pubtypes      609         0x0
.ARM.attributes       50         0x0
.debug_frame         440         0x0
.debug_line         1611         0x0
.comment              19         0x0
Total              12232

$ cargo objdump --bin app --release -- -disassemble -no-show-raw-insn -print-imm-hex
    Finished release [optimized + debuginfo] target(s) in 0.02s

app:	file format ELF32-arm-little


Disassembly of section .text:

00000400 main:
     400:      	push	{r7, lr}
     402:      	mov	r7, sp
     404:      	bl	#0x2
     408:      	trap

0000040a app::__cortex_m_rt_main::h340de3844f556f0d:
     40a:      	push	{r7, lr}
     40c:      	mov	r7, sp
     40e:      	bl	#0xa0
     412:      	b	#-0x4 <app::__cortex_m_rt_main::h340de3844f556f0d+0x8>

00000414 Reset:
     414:      	push	{r7, lr}
     416:      	mov	r7, sp
     418:      	bl	#0x94
     41c:      	movw	r0, #0x0
     420:      	movw	r1, #0x0
     424:      	movt	r0, #0x2000
     428:      	movt	r1, #0x2000
     42c:      	cmp	r1, r0
     42e:      	bhs	#0x28 <Reset+0x46>
     430:      	movw	r1, #0x0
     434:      	movs	r2, #0x0
     436:      	movt	r1, #0x2000
     43a:      	str	r2, [r1], #4
     43e:      	cmp	r1, r0
     440:      	itt	lo
     442:      	strlo	r2, [r1], #4
     446:      	cmplo	r1, r0
     448:      	bhs	#0xe <Reset+0x46>
     44a:      	str	r2, [r1], #4
     44e:      	cmp	r1, r0
     450:      	bhs	#0x6 <Reset+0x46>
     452:      	str	r2, [r1], #4
     456:      	cmp	r1, r0
     458:      	blo	#-0x22 <Reset+0x26>
     45a:      	movw	r0, #0x0
     45e:      	movw	r1, #0x0
     462:      	movt	r0, #0x2000
     466:      	movt	r1, #0x2000
     46a:      	cmp	r1, r0
     46c:      	bhs	#0x38 <Reset+0x94>
     46e:      	movw	r1, #0x4cc
     472:      	movw	r2, #0x0
     476:      	movt	r1, #0x0
     47a:      	movt	r2, #0x2000
     47e:      	ldr	r3, [r1]
     480:      	str	r3, [r2], #4
     484:      	cmp	r2, r0
     486:      	bhs	#0x1e <Reset+0x94>
     488:      	ldr	r3, [r1, #0x4]
     48a:      	str	r3, [r2], #4
     48e:      	cmp	r2, r0
     490:      	bhs	#0x14 <Reset+0x94>
     492:      	ldr	r3, [r1, #0x8]
     494:      	str	r3, [r2], #4
     498:      	cmp	r2, r0
     49a:      	bhs	#0xa <Reset+0x94>
     49c:      	ldr	r3, [r1, #0xc]
     49e:      	adds	r1, #0x10
     4a0:      	str	r3, [r2], #4
     4a4:      	cmp	r2, r0
     4a6:      	blo	#-0x2c <Reset+0x6a>
     4a8:      	bl	#-0xac
     4ac:      	trap

000004ae DefaultHandler_:
     4ae:      	b	#-0x4 <DefaultHandler_>

000004af UsageFault:
     4af:      	strb	r7, [r4, #0x3]

000004b0 DefaultPreInit:
     4b0:      	bx	lr

000004b1 __pre_init:
     4b1:      	strb	r7, [r0, #0x1]

000004b2 __nop:
     4b2:      	bx	lr

000004b4 HardFaultTrampoline:
     4b4:      	mov	r0, lr
     4b6:      	movs	r1, #0x4
     4b8:      	tst	r0, r1
     4ba:      	bne	#0x4 <HardFaultTrampoline+0xe>
     4bc:      	mrs	r0, msp
     4c0:      	b	#0x4 <HardFault_>
     4c2:      	mrs	r0, psp
     4c6:      	b	#-0x2 <HardFault_>

000004c8 HardFault_:
     4c8:      	b	#-0x4 <HardFault_>

000004c9 HardFault:
     4c9:      	bmi	#-0x32 <Reset+0x87>
     4cb:      	<unknown>
```

### example/hello

```
$ cargo build --example hello
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished dev [unoptimized + debuginfo] target(s) in 0.13s

$ qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!

$ echo $?
0

$ vi .cargo/config

# .cargo/configのrunnerを使う場合は、cargo run
$ cargo run --example hello --release
   Compiling app v0.1.0 (/Users/dspace/develop/rust/f4discovery/app)
    Finished release [optimized + debuginfo] target(s) in 0.29s
     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/examples/hello`
Hello, world!
```

### debug

```
# terminal 1
$ qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -gdb tcp::3333 -S -kernel target/thumbv7m-none-eabi/debug/examples/hello
Hello, world!
$

# terminal 2
$ gdb -q target/thumbv7m-none-eabi/debug/examples/hello
Reading symbols from target/thumbv7m-none-eabi/debug/examples/hello...
(gdb) target remote :3333
Remote debugging using :3333
0x000012a6 in core::num::flt2dec::strategy::dragon::format_shortest ()
    at src/libcore/num/flt2dec/strategy/dragon.rs:252
252	src/libcore/num/flt2dec/strategy/dragon.rs: No such file or directory.
(gdb) list main
6	use panic_halt as _;
7
8	use cortex_m_rt::entry;
9	use cortex_m_semihosting::{debug, hprintln};
10
11	#[entry]
12	fn main() -> ! {
13	    hprintln!("Hello, world!").unwrap();
14
15	    // exit QEMU
(gdb) break 13
Breakpoint 1 at 0x410: file examples/hello.rs, line 13.
(gdb) continue
Continuing.

Breakpoint 1, hello::__cortex_m_rt_main () at examples/hello.rs:13
13	    hprintln!("Hello, world!").unwrap();
(gdb) next
17	    debug::exit(debug::EXIT_SUCCESS);
(gdb) next
[Inferior 1 (process 1) exited normally]
(gdb) quit
$
```